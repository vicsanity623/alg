<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma | Local Drive Bridge</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown and Syntax Highlighting Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { background-color: #000; color: #e5e5e5; font-family: 'Inter', sans-serif; }
        .grok-input-shadow { box-shadow: 0 0 20px rgba(255,255,255,0.05); }
        .glass { background: rgba(12, 12, 12, 0.95); backdrop-filter: blur(16px); border-left: 1px solid #222; }
        .status-online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background: #ef4444; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .loading-shimmer { background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Markdown Styling */
        .prose pre { background: #111; padding: 1rem; border-radius: 0.75rem; border: 1px solid #333; margin: 0.5rem 0; overflow-x: auto; position: relative; }
        .prose code { font-family: 'Fira Code', monospace; font-size: 0.85rem; color: #fbbf24; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; list-style-type: disc; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; color: #fff; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose strong { color: #fff; font-weight: 600; }
        .copy-btn { opacity: 0; transition: opacity 0.2s; }
        .ai-bubble:hover .copy-btn { opacity: 1; }
        
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 0;
            display: flex;
            justify-content: center; /* Centers horizontally */
            align-items: center;     /* Centers vertically */
            background: rgba(10, 10, 10, 0.8); /* Semi-transparent black */
            backdrop-filter: blur(10px);       /* Matching your app's blur effect */
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
            font-size: 14px;
        }
        
        footer a {
            color: #007AFF; /* Your accent blue */
            text-decoration: none;
            margin-right: 10px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        footer a:hover {
            opacity: 0.7;
        }
        
        /* Removes the last separator bar | automatically */
        footer div span:last-child {
            display: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="h-14 border-b border-zinc-800 flex items-center justify-between px-5 bg-black z-50">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                <span class="text-black font-black text-xl italic leading-none">/</span>
            </div>
            <span class="font-bold tracking-tight text-white text-lg">Gemma <span class="text-zinc-500 font-normal">12B</span></span>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="clearHistory()" class="text-[10px] text-zinc-500 hover:text-red-400 font-bold uppercase tracking-widest mr-4">Clear Chat</button>
            <div id="statusIndicator" class="flex items-center gap-2 text-[10px] font-bold tracking-widest text-zinc-500">
                <div id="statusDot" class="w-2 h-2 rounded-full status-offline"></div>
                SYSTEM OFFLINE
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-zinc-900 rounded-full transition-all">
                <i data-lucide="settings" class="w-5 h-5 text-zinc-400"></i>
            </button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Chat Interface -->
        <div class="flex-1 flex flex-col relative bg-black">
            <div id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-8 max-w-3xl mx-auto w-full pt-16">
                <div id="welcomeScreen" class="text-center py-20 animate-in fade-in duration-1000">
                    <h1 class="text-5xl font-semibold text-white mb-6 tracking-tight">How can I help?</h1>
                    <p class="text-zinc-500 text-lg max-w-md mx-auto">Connected to your GGUF model via Google Drive & Colab T4 GPU.</p>
                </div>
            </div>

            <!-- Input Bar -->
            <div class="p-6">
                <div class="max-w-3xl mx-auto relative group">
                    <textarea id="userInput" rows="1" 
                        class="w-full bg-[#111] border border-zinc-800 rounded-2xl py-4 pl-6 pr-14 focus:outline-none focus:border-zinc-600 transition-all resize-none text-white placeholder-zinc-600"
                        placeholder="Ask anything..."></textarea>
                    <button onclick="handleSend()" class="absolute right-3 bottom-3 p-2 bg-white text-black rounded-xl hover:scale-105 active:scale-95 transition-all">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
                <p class="text-[10px] text-zinc-700 text-center mt-4 tracking-wide uppercase">GGUF Inference Mode â€¢ Google Colab Bridge</p>
            </div>
        </div>

        <!-- Settings Sidebar -->
        <div id="settingsPanel" class="fixed inset-y-0 right-0 w-full max-w-md glass z-[60] transform translate-x-full transition-transform duration-300 ease-out p-8 overflow-y-auto">
            <div class="flex items-center justify-between mb-10">
                <h2 class="text-2xl font-bold">Inference Settings</h2>
                <button onclick="toggleSettings()" class="p-2 hover:bg-zinc-800 rounded-lg"><i data-lucide="x"></i></button>
            </div>

            <!-- 1. Local Reference -->
            <div class="mb-10">
                <label class="text-xs font-bold text-zinc-500 uppercase tracking-widest block mb-4">1. Model File (Local Ref)</label>
                <div class="p-4 border border-zinc-800 rounded-xl bg-black/40">
                    <input type="file" id="fileInput" class="hidden" onchange="document.getElementById('fileStatus').innerText = this.files[0].name">
                    <button onclick="document.getElementById('fileInput').click()" class="flex items-center gap-3 text-sm text-zinc-400 hover:text-white transition-colors">
                        <i data-lucide="file-plus" class="w-5 h-5"></i>
                        <span id="fileStatus">Select .gguf from your device...</span>
                    </button>
                </div>
            </div>

            <!-- 2. Colab Setup -->
            <div class="mb-10">
                <label class="text-xs font-bold text-zinc-500 uppercase tracking-widest block mb-4">2. Colab Drive Bridge</label>
                <button onclick="openColabModal()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-indigo-500/10 mb-6">
                    View Setup Instructions
                </button>
                
                <div class="space-y-3">
                    <p class="text-[11px] text-zinc-500 uppercase font-bold px-1">Cloudflare Tunnel URL</p>
                    <input type="text" id="bridgeUrl" placeholder="https://...trycloudflare.com" 
                        class="w-full bg-black border border-zinc-800 rounded-xl py-4 px-4 focus:outline-none focus:border-indigo-500 text-sm text-indigo-400 font-mono">
                    <button id="connectBtn" onclick="testConnection()" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl text-sm font-bold transition-all">
                        Connect to Backend
                    </button>
                </div>
            </div>

            <!-- 3. Params -->
            <div class="space-y-6 border-t border-zinc-900 pt-10">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Temperature</label>
                    <span id="v-temp" class="text-indigo-400 font-mono text-sm">0.7</span>
                </div>
                <input type="range" id="temp" min="0" max="1.5" step="0.1" value="0.7" class="w-full accent-white" oninput="document.getElementById('v-temp').innerText=this.value; saveParams();">
            </div>
        </div>
    </main>

    <!-- Modal for Instructions -->
    <div id="scriptModal" class="hidden fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-[#0a0a0a] border border-zinc-800 w-full max-w-3xl rounded-3xl p-10 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-3xl font-bold mb-2 text-white">Drive Setup</h3>
                    <p class="text-zinc-500">Ensure your GGUF is in Google Drive at: <code class="text-indigo-400">/MyDrive/model.gguf</code></p>
                </div>
                <button onclick="closeColabModal()" class="p-2 hover:bg-zinc-900 rounded-full"><i data-lucide="x"></i></button>
            </div>

            <div class="space-y-8">
                <!-- Cell 1 -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-zinc-500 uppercase">Cell 1: Connect Drive & Install</span>
                        <button onclick="copyCode(1)" class="text-xs text-indigo-500 hover:underline">Copy Cell</button>
                    </div>
                    <pre class="bg-black border border-zinc-800 p-5 rounded-2xl text-[13px] text-green-500 font-mono overflow-x-auto">from google.colab import drive
drive.mount('/content/drive')

!pip install llama-cpp-python[server]
!wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
!dpkg -i cloudflared-linux-amd64.deb</pre>
                </div>

                <!-- Cell 2 -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-zinc-500 uppercase">Cell 2: Run Inference Server</span>
                        <button onclick="copyCode(2)" class="text-xs text-indigo-500 hover:underline">Copy Cell</button>
                    </div>
                    <pre class="bg-black border border-zinc-800 p-5 rounded-2xl text-[13px] text-indigo-400 font-mono overflow-x-auto">import os, threading

# Path to your file on Drive
model_path = "/content/drive/MyDrive/model.gguf"

def run_server():
    print("--- STARTING LOCAL DRIVE MODEL ---")
    # Using all GPU layers for T4
    os.system(f"python3 -m llama_cpp.server --model {model_path} --n_gpu_layers -1 --host 0.0.0.0 --port 8000")

threading.Thread(target=run_server).start()

print("--- INITIALIZING TUNNEL ---")
!cloudflared tunnel --url http://localhost:8000</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let apiEndpoint = localStorage.getItem('gemma_bridge_url') || "";
        let isConnected = false;
        let chatHistory = JSON.parse(localStorage.getItem('gemma_chat_history')) || [];

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            if (apiEndpoint) {
                document.getElementById('bridgeUrl').value = apiEndpoint;
                testConnection();
            }
            if (chatHistory.length > 0) {
                document.getElementById('welcomeScreen').classList.add('hidden');
                chatHistory.forEach(msg => appendMsg(msg.role, msg.content, false));
            }
            document.getElementById('temp').value = localStorage.getItem('gemma_temp') || 0.7;
            document.getElementById('v-temp').innerText = document.getElementById('temp').value;
        });

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('translate-x-full');
        }

        function openColabModal() { document.getElementById('scriptModal').classList.remove('hidden'); }
        function closeColabModal() { document.getElementById('scriptModal').classList.add('hidden'); }

        function copyCode(id) {
            const codes = [
                "",
                "from google.colab import drive\ndrive.mount('/content/drive')\n\n!pip install llama-cpp-python[server]\n!wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb\n!dpkg -i cloudflared-linux-amd64.deb",
                "import os, threading\n\nmodel_path = \"/content/drive/MyDrive/model.gguf\"\n\ndef run_server():\n    os.system(f\"python3 -m llama_cpp.server --model {model_path} --n_gpu_layers -1 --host 0.0.0.0 --port 8000\")\n\nthreading.Thread(target=run_server).start()\n!cloudflared tunnel --url http://localhost:8000"
            ];
            navigator.clipboard.writeText(codes[id]);
            alert("Code Copied!");
        }

        function saveParams() {
            localStorage.setItem('gemma_temp', document.getElementById('temp').value);
        }

        async function testConnection() {
            const url = document.getElementById('bridgeUrl').value.trim().replace(/\/$/, "");
            const btn = document.getElementById('connectBtn');
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusIndicator');

            btn.innerText = "VERIFYING...";
            
            try {
                const resp = await fetch(`${url}/v1/models`);
                if (resp.ok) {
                    apiEndpoint = url;
                    localStorage.setItem('gemma_bridge_url', url);
                    isConnected = true;
                    dot.className = "w-2 h-2 rounded-full status-online";
                    statusText.innerHTML = `<div class="w-2 h-2 rounded-full status-online"></div> SYSTEM ONLINE`;
                    statusText.className = "flex items-center gap-2 text-[10px] font-bold tracking-widest text-green-500";
                    btn.innerText = "CONNECTED";
                    btn.className = "w-full bg-green-600/20 text-green-500 border border-green-500/50 py-3 rounded-xl text-sm font-bold";
                } else { throw new Error(); }
            } catch (e) {
                btn.innerText = "RETRY CONNECTION";
                isConnected = false;
            }
        }

        function clearHistory() {
            if(confirm("Clear all chat history?")) {
                localStorage.removeItem('gemma_chat_history');
                location.reload();
            }
        }

        async function handleSend() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text || !isConnected) return;

            document.getElementById('welcomeScreen').classList.add('hidden');
            appendMsg('user', text, true);
            input.value = "";
            
            const aiDiv = appendMsg('ai', "", false);
            const contentDiv = aiDiv.querySelector('.prose');
            let fullContent = "";

            try {
                const response = await fetch(`${apiEndpoint}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{role: "user", content: text}],
                        temperature: parseFloat(document.getElementById('temp').value),
                        model: "model",
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        const message = line.replace(/^data: /, '').trim();
                        if (message === '' || message === '[DONE]') continue;

                        try {
                            const parsed = JSON.parse(message);
                            const content = parsed.choices[0].delta.content;
                            if (content) {
                                fullContent += content;
                                contentDiv.innerHTML = marked.parse(fullContent);
                                hljs.highlightAll();
                                const box = document.getElementById('chatBox');
                                box.scrollTop = box.scrollHeight;
                            }
                        } catch (e) {}
                    }
                }
                chatHistory.push({role: 'ai', content: fullContent});
                localStorage.setItem('gemma_chat_history', JSON.stringify(chatHistory));
            } catch (err) {
                contentDiv.innerText = "Error: Connection lost.";
            }
        }

        function appendMsg(role, text, save = true) {
            if (save) {
                chatHistory.push({role, content: text});
                localStorage.setItem('gemma_chat_history', JSON.stringify(chatHistory));
            }

            const box = document.getElementById('chatBox');
            const wrap = document.createElement('div');
            wrap.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 duration-300`;
            
            const inner = document.createElement('div');
            inner.className = role === 'user' 
                ? 'bg-[#222] text-white px-5 py-3 rounded-2xl max-w-[85%] border border-white/5 shadow-xl' 
                : 'ai-bubble text-zinc-100 px-5 py-3 rounded-2xl max-w-[95%] border-l-2 border-zinc-800 w-full';
            
            const content = document.createElement('div');
            content.className = "prose prose-invert max-w-none";
            content.innerHTML = marked.parse(text);
            
            inner.appendChild(content);

            if (role === 'ai') {
                const actions = document.createElement('div');
                actions.className = "flex mt-2 pt-2 border-t border-zinc-900 justify-end";
                actions.innerHTML = `
                    <button onclick="copyToClipboard(this)" class="copy-btn flex items-center gap-1 text-[10px] text-zinc-500 hover:text-white uppercase font-bold tracking-tighter transition-all">
                        <i data-lucide="copy" class="w-3 h-3"></i> Copy
                    </button>
                `;
                inner.appendChild(actions);
                lucide.createIcons({attrs: {class: 'w-3 h-3'}, nameList: ['copy']});
            }

            wrap.appendChild(inner);
            box.appendChild(wrap);
            hljs.highlightAll();
            box.scrollTop = box.scrollHeight;
            return inner;
        }

        function copyToClipboard(btn) {
            const text = btn.closest('.ai-bubble').querySelector('.prose').innerText;
            navigator.clipboard.writeText(text);
            const original = btn.innerHTML;
            btn.innerHTML = "Copied!";
            setTimeout(() => btn.innerHTML = original, 2000);
        }

        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
        });
    </script>
    <footer>
        <div>
            <a href="artist.html">Sketch Canvas</a>
            <span>|</span>
        </div>
    </footer>
</body>
</html>