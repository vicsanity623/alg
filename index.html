<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox IDE ‚Ä¢ v0.0.1</title>
    
    <!-- CodeMirror Editor Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    
    <!-- Roadmap Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #1e1e2e;
            --bg-panel: #282a36;
            --text-main: #f8f8f2;
            --accent: #bd93f9;
            --border: #44475a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { display: flex; flex-direction: column; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* Toolbar */
        #toolbar { height: 50px; flex-shrink: 0; background: var(--bg-panel); display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border); justify-content: space-between; }
        .toolbar-title { font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn { background: var(--accent); color: #000; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; color: var(--text-main); border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--border); }
        .btn-group { display: flex; gap: 8px; }

        /* Main Workspace */
        #workspace { display: flex; flex: 1; height: calc(100vh - 50px); overflow: hidden; }

        /* Sidebar (Files) */
        #sidebar { width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #8be9fd; }
        #file-list { flex: 1; overflow-y: auto; list-style: none; }
        .file-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-family: monospace; font-size: 13px; }
        .file-item:hover { background: #44475a; }
        .file-item.active { background: var(--accent); color: #000; font-weight: bold; border-left: 4px solid #ff79c6; }

        /* Editor Area */
        #editor-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); min-width: 0; }
        .panel-header { background: var(--bg-panel); padding: 5px 15px; font-size: 13px; font-family: monospace; border-bottom: 1px solid var(--border); color: #f1fa8c; display: flex; justify-content: space-between; align-items: center; }
        .CodeMirror { flex: 1; height: 100% !important; font-size: 14px; }

        /* Version Badge */
        .version-badge {
            background: rgba(139, 233, 253, 0.1);
            color: #8be9fd;
            border: 1px solid rgba(139, 233, 253, 0.3);
            font-size: 11px;
            font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace;
            padding: 3px 8px;
            border-radius: 9999px;
            margin-left: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(139, 233, 253, 0.05);
            vertical-align: middle;
        }

        /* Right Panel (Preview + Console) */
        #right-panel { width: 40%; display: flex; flex-direction: column; flex-shrink: 0; }
        #preview-container { flex: 1; display: flex; flex-direction: column; border-bottom: 1px solid var(--border); }
        iframe { flex: 1; border: none; background: #fff; width: 100%; height: 100%; }

        #console-container { height: 35%; display: flex; flex-direction: column; background: var(--bg-panel); }
        #console-output { flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 13px; color: #f8f8f2; }
        .log-row { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 4px; word-wrap: break-word; }
        .log-error { color: #ff5555; }
        .log-warn { color: #f1fa8c; }
        
        .clear-btn { background: none; border: 1px solid var(--border); color: #fff; cursor: pointer; padding: 2px 6px; border-radius: 3px; font-size: 11px; }

        /* Mobile Responsiveness */
        @media (max-width: 800px) {
            body { height: auto; overflow-y: auto; overflow-x: hidden; }
            #workspace { flex-direction: column; height: auto; overflow: visible; }
            
            /* Sidebar becomes horizontal swipeable on mobile */
            #sidebar { width: 100%; border-right: none; height: auto; border-bottom: 1px solid var(--border); }
            #file-list { display: flex; flex-direction: row; overflow-x: auto; white-space: nowrap; max-height: 50px; }
            .file-item { border-bottom: none; border-right: 1px solid var(--border); flex: 0 0 auto; border-left: none; }
            .file-item.active { border-bottom: 4px solid #ff79c6; border-left: none; }
            
            /* Give Editor a fixed height on mobile so you can scroll past it */
            #editor-container { height: 60vh; border-right: none; border-bottom: 1px solid var(--border); }
            
            /* Stack Preview and Console */
            #right-panel { width: 100%; height: auto; flex-direction: column; }
            #preview-container { height: 50vh; }
            #console-container { height: 40vh; border-top: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="toolbar-title">
            üõ†Ô∏è Sandbox IDE
            <span class="version-badge">v0.0.1</span>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline" onclick="exportZip()">üì¶ Export ZIP</button>
            <button class="btn" onclick="runCode()">‚ñ∂ Run</button>
        </div>
    </div>

    <div id="workspace">
        <!-- File Manager -->
        <div id="sidebar">
            <div class="sidebar-header">
                FILES
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-outline" style="padding: 2px 6px; font-size: 12px;" onclick="resetProject()" title="Reset Project">‚Ü∫</button>
                    <button class="btn btn-outline" style="padding: 2px 8px;" onclick="createFile()" title="New File">+</button>
                </div>
            </div>
            <ul id="file-list"></ul>
        </div>

        <!-- Code Editor -->
        <div id="editor-container">
            <div class="panel-header">
                <span id="current-file-name">index.html</span>
                <button class="btn btn-outline" style="padding: 2px 8px; font-size: 11px;" onclick="insertTab()" title="Insert Indentation">‚á• TAB</button>
            </div>
            <textarea id="code-editor"></textarea>
        </div>

        <!-- Preview & Console -->
        <div id="right-panel">
            <div id="preview-container">
                <div class="panel-header">Live Preview</div>
                <iframe id="preview"></iframe>
            </div>
            <div id="console-container">
                <div class="panel-header">
                    Console
                    <button class="clear-btn" onclick="clearConsole()">Clear</button>
                </div>
                <div id="console-output"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. Initial Default State
        const defaultFiles = {
            "index.html": `<canvas id="game"></canvas>\n<script src="index.js"><\/script>`,
            "index.js": `const BACKGROUND = "#101010";\nconst FOREGROUND = "#50FF50";\n\nconsole.log("Canvas Element:", game);\ngame.width = window.innerWidth;\ngame.height = window.innerHeight;\nconst ctx = game.getContext("2d");\nconsole.log("Context:", ctx);\n\nfunction clear() {\n  ctx.fillStyle = BACKGROUND;\n  ctx.fillRect(0, 0, game.width, game.height);\n}\n\nfunction point(x, y) {\n  const s = 40;\n  ctx.fillStyle = FOREGROUND;\n  ctx.fillRect(x, y, s, s);\n}\n\nclear();\npoint(50, 50);\npoint(150, 100);`,
            "README.md": `# Welcome to SandboxIDE\n\n- Write HTML/JS/CSS.\n- Click **Run**.\n- Check out the bottom panel!\n\n*(You can run this Markdown file too!)*`
        };

        // Load from LocalStorage if exists, otherwise use defaults
        let files = JSON.parse(localStorage.getItem("sandboxIDE_files")) || { ...defaultFiles };
        let currentFile = "index.html";

        // Save to LocalStorage
        function saveToLocal() {
            localStorage.setItem("sandboxIDE_files", JSON.stringify(files));
        }

        // Reset functionality
        function resetProject() {
            if(confirm("Are you sure you want to reset? This will delete all your current code!")) {
                localStorage.removeItem("sandboxIDE_files");
                files = { ...defaultFiles };
                openFile("index.html");
                runCode();
            }
        }

        // 2. Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            lineNumbers: true,
            theme: "dracula",
            mode: "htmlmixed",
            tabSize: 2,
            indentWithTabs: false,
            lineWrapping: true
        });

        // 3. Save code changes to the virtual file system
        editor.on("change", () => {
            files[currentFile] = editor.getValue();
            saveToLocal();
        });

        // Tab Button Function (Crucial for Mobile)
        function insertTab() {
            editor.replaceSelection("  "); // Inserts two spaces
            editor.focus();
        }

        // 4. UI Rendering Functions
        function renderFileList() {
            const list = document.getElementById("file-list");
            list.innerHTML = "";
            for (const fileName in files) {
                const li = document.createElement("li");
                li.className = "file-item " + (fileName === currentFile ? "active" : "");
                li.innerText = fileName;
                li.onclick = () => openFile(fileName);
                list.appendChild(li);
            }
        }

        function openFile(fileName) {
            currentFile = fileName;
            document.getElementById("current-file-name").innerText = fileName;
            
            // Set Editor Value without triggering a false "change" save
            editor.setValue(files[fileName] || "");
            
            // Switch syntax highlighting mode
            if (fileName.endsWith(".js")) editor.setOption("mode", "javascript");
            else if (fileName.endsWith(".css")) editor.setOption("mode", "css");
            else if (fileName.endsWith(".md")) editor.setOption("mode", "markdown");
            else editor.setOption("mode", "htmlmixed");

            renderFileList();
        }

        function createFile() {
            const fileName = prompt("Enter file name (e.g., style.css, script.js, index.html):");
            if (fileName && !files[fileName]) {
                files[fileName] = "";
                saveToLocal();
                openFile(fileName);
            }
        }

        // 5. Console Logic
        function clearConsole() {
            document.getElementById("console-output").innerHTML = "";
        }

        function logToConsole(msg, type = 'log') {
            const output = document.getElementById("console-output");
            const div = document.createElement("div");
            div.className = `log-row log-${type}`;
            div.innerText = msg;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        // Listen for console messages sent from the iframe
        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === 'console') {
                logToConsole(event.data.args.join(" "), event.data.level);
            }
        });

        // Interceptor injected into iframe to catch logs and serialize Complex Objects natively
        const consoleInterceptorScript = `
            <script>
                (function() {
                    function serialize(arg) {
                        if (arg === null) return 'null';
                        if (arg === undefined) return 'undefined';
                        if (arg instanceof HTMLElement) return '<' + arg.tagName.toLowerCase() + (arg.id ? ' id="' + arg.id + '"' : '') + '>';
                        if (arg.toString() === '[object CanvasRenderingContext2D]') return 'CanvasRenderingContext2D { canvas, fillStyle, ... }';
                        if (typeof arg === 'object') {
                            try { return JSON.stringify(arg, null, 2); } 
                            catch (e) { return Object.prototype.toString.call(arg); }
                        }
                        return arg.toString();
                    }

                    const methods = ['log', 'warn', 'error', 'info'];
                    methods.forEach(method => {
                        const original = console[method];
                        console[method] = function(...args) {
                            window.parent.postMessage({ type: 'console', level: method, args: args.map(serialize) }, '*');
                            original.apply(console, args);
                        };
                    });

                    window.onerror = function(msg, url, line) {
                        console.error(msg + ' (Line: ' + line + ')');
                        return false;
                    };
                })();
            <\/script>
        `;

        // 6. The "Bundler" - Replaces <script src="..."> with inline files
        function runCode() {
            clearConsole();
            const iframe = document.getElementById("preview");
            
            // Markdown Support
            if (currentFile.endsWith(".md")) {
                const mdHtml = marked.parse(files[currentFile]);
                iframe.srcdoc = `<html><head><style>body{font-family:sans-serif; padding:20px; line-height:1.6; color:#333;}</style></head><body>${mdHtml}</body></html>`;
                return;
            }

            // Normal HTML Bundling
            let htmlContent = files["index.html"] || "<h1>No index.html found. Create one to run web apps!</h1>";

            // Inject the console interceptor at the very top
            htmlContent = consoleInterceptorScript + htmlContent;

            // Bundle local JS
            htmlContent = htmlContent.replace(/<script\s+[^>]*src=["']([^"']+)["'][^>]*>[\s\S]*?<\/script>/gi, (match, src) => {
                if (files[src]) {
                    const safeJs = files[src].replace(/<\/script>/gi, "<\\/script>");
                    return `<script>${safeJs}<\/script>`;
                }
                return match; 
            });

            // Bundle local CSS
            htmlContent = htmlContent.replace(/<link\s+[^>]*href=["']([^"']+)["'][^>]*>/gi, (match, href) => {
                if (files[href]) {
                    return `<style>${files[href]}</style>`;
                }
                return match;
            });

            iframe.srcdoc = htmlContent;
        }

        // 7. Drag and Drop File Import
        document.body.addEventListener("dragover", (e) => e.preventDefault());
        document.body.addEventListener("drop", (e) => {
            e.preventDefault();
            for (const file of e.dataTransfer.files) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    files[file.name] = event.target.result;
                    saveToLocal();
                    renderFileList();
                    openFile(file.name);
                };
                reader.readAsText(file);
            }
        });

        // 8. ZIP Export Functionality
        async function exportZip() {
            const zip = new JSZip();
            for (const [name, content] of Object.entries(files)) {
                zip.file(name, content);
            }
            const blob = await zip.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "sandbox-project.zip";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize App
        if (!files["index.html"]) files = { ...defaultFiles }; // Fail-safe
        renderFileList();
        openFile("index.js"); // Open JS by default to show it's there
        runCode(); // Run automatically on load

    </script>
</body>
</html>
